DROP TABLE IF EXISTS t1, t2;
DROP VIEW IF EXISTS v1;
DROP PROCEDURE IF EXISTS stp_t;
SET autocommit=0;
SET autocommit=0;
SET autocommit=0;
connection default;
CREATE TABLE t1 (k INT NOT NULL PRIMARY KEY, i INT, j INT, l INT) ENGINE=NDB;
INSERT INTO t1 VALUES (1,123,1,123);
INSERT INTO t1 VALUES (2,124,2,124);
INSERT INTO t1 VALUES (3,125,3,125);
INSERT INTO t1 VALUES (4,126,4,126);
INSERT INTO t1 VALUES (5,127,5,127);
INSERT INTO t1 VALUES (6,128,6,128);
CREATE INDEX ixi ON t1 (i);
CREATE TABLE t2 (k INT NOT NULL PRIMARY KEY, i INT, j INT, l INT) ENGINE=NDB;
INSERT INTO t2 VALUES (1,123,1,123);
INSERT INTO t2 VALUES (2,124,2,124);
INSERT INTO t2 VALUES (3,125,3,125);
INSERT INTO t2 VALUES (4,126,4,126);
INSERT INTO t2 VALUES (5,127,5,127);
INSERT INTO t2 VALUES (6,128,6,128);
CREATE INDEX ixi ON t2 (i);
CREATE VIEW v1 AS SELECT t1.i from t1;
CREATE PROCEDURE stp_t (IN p1 int, IN p2 int) MODIFIES SQL DATA
BEGIN
UPDATE t2 SET i = p2 WHERE i = p1;
UPDATE v1 SET i = p2 WHERE i = p1;
SELECT * FROM v1 ORDER BY i;
SELECT * FROM t1 ORDER BY t1.k;
SELECT * FROM t2 ORDER BY t2.k;
END;
|
COMMIT;
SELECT @@global.tx_isolation;
@@global.tx_isolation
REPEATABLE-READ
EXPLAIN SELECT t1.i FROM t1 WHERE t1.i< 125 FOR UPDATE;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	range	ixi	ixi	5	NULL	10	Using where
SELECT t1.i FROM t1 WHERE t1.i< 125 FOR UPDATE;
i
123
124
connection root1;
CALL stp_t (125, 225);
i
123
124
126
127
128
225
k	i	j	l
1	123	1	123
2	124	2	124
3	225	3	125
4	126	4	126
5	127	5	127
6	128	6	128
k	i	j	l
1	123	1	123
2	124	2	124
3	225	3	125
4	126	4	126
5	127	5	127
6	128	6	128
connection root2;
CALL stp_t (127, 227);
i
123
124
125
126
128
227
k	i	j	l
1	123	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	227	5	127
6	128	6	128
k	i	j	l
1	123	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	227	5	127
6	128	6	128
connection default;
CALL stp_t (123, 223);
i
124
125
126
127
128
223
k	i	j	l
1	223	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
k	i	j	l
1	223	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
connection root1;
CALL stp_t (126, 226);
i
123
124
127
128
225
226
k	i	j	l
1	123	1	123
2	124	2	124
3	225	3	125
4	226	4	126
5	127	5	127
6	128	6	128
k	i	j	l
1	123	1	123
2	124	2	124
3	225	3	125
4	226	4	126
5	127	5	127
6	128	6	128
connection root2;
CALL stp_t (128, 228);
i
123
124
125
126
227
228
k	i	j	l
1	123	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	227	5	127
6	228	6	128
k	i	j	l
1	123	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	227	5	127
6	228	6	128
connection default;
CALL stp_t (124, 224);
i
125
126
127
128
223
224
k	i	j	l
1	223	1	123
2	224	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
k	i	j	l
1	223	1	123
2	224	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
connection root1;
DELETE FROM t1 WHERE t1.i=226;
SELECT * FROM t1 ORDER BY t1.k;
k	i	j	l
1	123	1	123
2	124	2	124
3	225	3	125
5	127	5	127
6	128	6	128
SELECT * FROM t2 ORDER BY t2.k;
k	i	j	l
1	123	1	123
2	124	2	124
3	225	3	125
4	226	4	126
5	127	5	127
6	128	6	128
connection root2;
DELETE FROM t1 WHERE t1.i=228;
SELECT * FROM t1 ORDER BY t1.k;
k	i	j	l
1	123	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	227	5	127
SELECT * FROM t2 ORDER BY t2.k;
k	i	j	l
1	123	1	123
2	124	2	124
3	125	3	125
4	126	4	126
5	227	5	127
6	228	6	128
connection default;
DELETE FROM t1 WHERE t1.i=224;
SELECT * FROM t1 ORDER BY t1.k;
k	i	j	l
1	223	1	123
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
SELECT * FROM t2 ORDER BY t2.k;
k	i	j	l
1	223	1	123
2	224	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
COMMIT;
connection root1;
ROLLBACK;
connection root1;
COMMIT;
connection default;
SELECT * FROM v1 ORDER BY i;
i
125
126
127
128
223
SELECT * FROM t1 ORDER BY t1.k;
k	i	j	l
1	223	1	123
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
SELECT * FROM t2 ORDER BY t2.k;
k	i	j	l
1	223	1	123
2	224	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
connection root1;
SELECT * FROM v1 ORDER BY i;
i
125
126
127
128
223
SELECT * FROM t1 ORDER BY t1.k;
k	i	j	l
1	223	1	123
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
SELECT * FROM t2 ORDER BY t2.k;
k	i	j	l
1	223	1	123
2	224	2	124
3	125	3	125
4	126	4	126
5	127	5	127
6	128	6	128
connection root2;
SELECT * FROM v1 ORDER BY i;
i
125
126
223
227
SELECT * FROM t1 ORDER BY t1.k;
k	i	j	l
1	223	1	123
3	125	3	125
4	126	4	126
5	227	5	127
SELECT * FROM t2 ORDER BY t2.k;
k	i	j	l
1	223	1	123
2	224	2	124
3	125	3	125
4	126	4	126
5	227	5	127
6	228	6	128
connection default;
DROP VIEW v1;
DROP PROCEDURE stp_t;
DROP TABLE t1, t2;
