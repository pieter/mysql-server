SET storage_engine = Falcon;
#
# Bug #22847: Falcon: Unnecessary blockage for nulls
#
--disable_warnings
DROP TABLE IF EXISTS t1;
--enable_warnings

CREATE TABLE t1 (a int, unique (a));

--echo # Establish connection conn1 (user = root)
connect (conn1,localhost,root,,);
SET storage_engine = Falcon;

--echo *** Bug #22847 - Test 1 ***

--echo # Switch to connection default
connection default;
START TRANSACTION;
INSERT INTO t1 VALUES (null);

--echo # Switch to connection conn1
connection conn1;
START TRANSACTION;
INSERT INTO t1 VALUES (null);
COMMIT;

--echo # Switch to connection default
connection default;
SELECT COUNT(*) FROM t1 WHERE a IS NULL;
COMMIT;
SELECT COUNT(*) FROM t1 WHERE a IS NULL;
DELETE FROM t1;

--echo *** Bug #22847 - Test 2 ***

SET @@tx_isolation = 'REPEATABLE-READ';
START TRANSACTION;
INSERT INTO t1 VALUES (1);

--echo # Switch to connection conn1
connection conn1;
INSERT INTO t1 VALUES (2);
START TRANSACTION;
UPDATE t1 SET a = 3 where a = 2;
UPDATE t1 SET a = 4 where a = 3;

--echo # Switch to connection default
connection default;
SELECT * FROM t1;
--error ER_DUP_ENTRY
INSERT INTO t1 VALUES (2);
INSERT INTO t1 VALUES (3);
SELECT * FROM t1;
COMMIT;

--echo # Switch to connection conn1
connection conn1;
COMMIT;
DELETE FROM t1;


--echo *** Bug #22847 - Test 3 ***

SET @@tx_isolation = 'READ-COMMITTED';
START TRANSACTION;
INSERT INTO t1 VALUES (1);

--echo # Switch to connection default
connection default;
INSERT INTO t1 VALUES (2);
START TRANSACTION;
UPDATE t1 SET a = 3 where a = 2;
UPDATE t1 SET a = 4 where a = 3;

--echo # Switch to connection conn1
connection conn1;
SELECT * FROM t1;
INSERT INTO t1 VALUES (3);
SELECT * FROM t1;
COMMIT;

--echo # Switch to connection default
connection default;
COMMIT;

# Final cleanup.
disconnect conn1;
DROP TABLE t1;
