--source include/have_falcon.inc
#
# Bug #32413: Memory usage not constrained by falcon_record_memory_max, assertion failure
#
--echo *** Bug #32413 ***

# ----------------------------------------------------- #
# --- Initialisation                                --- #
# ----------------------------------------------------- #
let $engine = 'Falcon';
eval SET @@storage_engine = $engine;
SELECT @@GLOBAL.falcon_record_memory_max INTO @previous_falcon_record_memory_max;

--disable_warnings
DROP TABLE IF EXISTS t1;
DROP TABLE IF EXISTS t2;
--enable_warnings

# ----------------------------------------------------- #
# --- Test                                          --- #
# ----------------------------------------------------- #

# Set a very low record cache size.
SET GLOBAL falcon_record_memory_max = 16 * 1024 * 1024;

CREATE TABLE t1 (
  a INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  b INT,
  c VARCHAR(200),
  d VARCHAR(1000),
  INDEX (b,c),
  INDEX (d)
);

# Force record cache out-of-memory condition.
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF'));
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;
--error 1296
INSERT INTO t1 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t1;

# Try again with sufficient record cache.
SET GLOBAL falcon_record_memory_max = 128 * 1024 * 1024;

CREATE TABLE t2 (
  a INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
  b INT,
  c VARCHAR(200),
  d VARCHAR(1000),
  INDEX (b,c),
  INDEX (d)
);

INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF'));
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;
INSERT INTO t2 SELECT NULL, 12345, SHA('12345'), CONCAT(SHA('12345'), SHA('ABCDEF')) FROM t2;

# ----------------------------------------------------- #
# --- Check                                         --- #
# ----------------------------------------------------- #
SELECT count(*) from t1;
SELECT count(*) from t2;

# ----------------------------------------------------- #
# --- Final cleanup                                 --- #
# ----------------------------------------------------- #
DROP TABLE t1;
DROP TABLE t2;
SET GLOBAL falcon_record_memory_max = @previous_falcon_record_memory_max;
