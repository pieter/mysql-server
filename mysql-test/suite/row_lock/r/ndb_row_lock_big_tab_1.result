DROP TABLE IF EXISTS t1, t2;
DROP VIEW IF EXISTS v1;
SET autocommit=0;
SET autocommit=0;
connection default;
CREATE TABLE t1 (k INT NOT NULL PRIMARY KEY, i INT, j INT, l INT) ENGINE=NDB;
CREATE INDEX ixi ON t1 (i);
CREATE TABLE t2 (k INT NOT NULL PRIMARY KEY, i INT, j INT, l INT) ENGINE=NDB;
CREATE INDEX ixi ON t2 (i);
CREATE PROCEDURE fill_t1 (IN upb int)
BEGIN
DECLARE cnt int DEFAULT 0;
WHILE cnt < upb DO
INSERT INTO t1 VALUES (cnt, cnt+100, cnt, cnt+100);
SET cnt= cnt+1;
END WHILE; 
END;
|
CREATE FUNCTION half_t1() RETURNS int
BEGIN
DECLARE res int DEFAULT 0;
SELECT MOD(k,2) INTO res FROM t1;
RETURN  res;
END;
|
CREATE PROCEDURE fill_t2 (IN upb int)
BEGIN
DECLARE cnt int DEFAULT 0;
WHILE cnt < upb DO
INSERT INTO t2 VALUES (cnt, cnt+100, cnt, cnt+100);
SET cnt= cnt+1;
END WHILE; 
END;
|
CREATE FUNCTION half_t2() RETURNS int
BEGIN
DECLARE res int DEFAULT 0;
SELECT MOD(k,2) INTO res FROM t2;
RETURN  res;
END;
|
CALL fill_t1 (200);
CALL fill_t2 (200);
COMMIT;
SELECT @@global.tx_isolation;
@@global.tx_isolation
REPEATABLE-READ
EXPLAIN SELECT t1.i,t2.i FROM t1,t2 WHERE t1.i < t1.k % 2 = 0 AND t2.k=t1.k LOCK IN SHARE MODE;
id	select_type	table	type	possible_keys	key	key_len	ref	rows	Extra
1	SIMPLE	t1	ALL	PRIMARY	NULL	NULL	NULL	200	Using where
1	SIMPLE	t2	eq_ref	PRIMARY	PRIMARY	4	test.t1.k	1	
SELECT t1.i,t2.i FROM t1,t2 WHERE t1.i < t1.k % 2 = 0 AND t2.k=t1.k LOCK IN SHARE MODE;
i	i
135	135
119	119
211	211
184	184
232	232
105	105
188	188
216	216
255	255
154	154
197	197
279	279
218	218
127	127
203	203
281	281
194	194
161	161
276	276
122	122
139	139
183	183
114	114
247	247
144	144
148	148
174	174
267	267
142	142
168	168
226	226
258	258
231	231
146	146
253	253
189	189
230	230
290	290
178	178
158	158
130	130
214	214
133	133
229	229
294	294
295	295
108	108
112	112
297	297
151	151
251	251
270	270
291	291
159	159
132	132
121	121
244	244
272	272
293	293
186	186
111	111
166	166
201	201
175	175
180	180
209	209
192	192
246	246
195	195
107	107
233	233
239	239
103	103
109	109
128	128
266	266
143	143
160	160
187	187
243	243
273	273
259	259
110	110
176	176
141	141
170	170
215	215
191	191
200	200
271	271
162	162
260	260
106	106
150	150
126	126
147	147
155	155
193	193
207	207
287	287
235	235
252	252
129	129
205	205
268	268
278	278
116	116
137	137
199	199
217	217
234	234
190	190
236	236
257	257
100	100
210	210
212	212
264	264
221	221
241	241
256	256
262	262
265	265
269	269
277	277
173	173
177	177
208	208
219	219
285	285
101	101
164	164
113	113
125	125
202	202
140	140
156	156
282	282
181	181
206	206
299	299
102	102
145	145
227	227
196	196
138	138
198	198
204	204
237	237
171	171
284	284
263	263
292	292
104	104
149	149
250	250
296	296
228	228
280	280
242	242
248	248
185	185
220	220
245	245
275	275
118	118
120	120
152	152
153	153
157	157
182	182
179	179
254	254
288	288
172	172
283	283
286	286
115	115
238	238
289	289
131	131
223	223
134	134
136	136
222	222
225	225
261	261
274	274
123	123
163	163
224	224
117	117
298	298
169	169
124	124
167	167
240	240
249	249
165	165
213	213
connection root1;
SELECT t1.i,t2.i FROM t1,t2 WHERE t1.k % 2= 1 AND t1.k = t2.k LOCK IN SHARE MODE;
i	i
209	209
195	195
107	107
233	233
239	239
103	103
109	109
143	143
187	187
243	243
273	273
259	259
141	141
215	215
191	191
271	271
147	147
155	155
193	193
207	207
287	287
235	235
129	129
205	205
137	137
199	199
217	217
257	257
221	221
241	241
265	265
269	269
277	277
173	173
177	177
135	135
119	119
211	211
105	105
255	255
197	197
279	279
127	127
203	203
281	281
161	161
139	139
183	183
247	247
267	267
231	231
253	253
189	189
133	133
229	229
295	295
297	297
151	151
251	251
291	291
159	159
121	121
293	293
111	111
201	201
175	175
185	185
245	245
275	275
153	153
157	157
179	179
283	283
115	115
289	289
131	131
223	223
225	225
261	261
123	123
163	163
117	117
169	169
167	167
249	249
165	165
213	213
219	219
285	285
101	101
113	113
125	125
181	181
299	299
145	145
227	227
237	237
171	171
263	263
149	149
UPDATE t1,t2 SET t1.i=1111,t2.i=2222 WHERE t1.k % 2 = 1 AND t1.k = t2.k;
